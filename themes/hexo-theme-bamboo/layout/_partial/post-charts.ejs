<style type="text/css">
  .posts-chart {
    display: flex;
    flex-wrap: wrap;
  }
  .aaaa {
    width: 600px;
    height: 600px;
    background-color: rebeccapurple;
  }
</style>
<div class="post-charts">
  <div id="test1" class="aaaa"></div>
    <div id="test2" class="aaaa"></div>
    <div id="test3" class="aaaa"></div>
  </div>
</div>

<script
  src="<%- url_for('/js/echarts.min.js') %>"
  type="text/javascript"
></script>
<script type="text/javascript">
      var myChart1 = echarts.init(document.getElementById("test1"));
      var myChart2 = echarts.init(document.getElementById("test2"));
      var myChart3 = echarts.init(document.getElementById("test3"));

      <%
      /* calculate postsOption data. */
      var startDate = moment().subtract(1, 'years').startOf('month');
      var endDate = moment().endOf('month');

      var monthMap = new Map();
      var dayTime = 3600 * 24 * 1000;
      for (var time = startDate; time <= endDate; time += dayTime) {
          var month = moment(time).format('YYYY-MM');
          if (!monthMap.has(month)) {
              monthMap.set(month, 0);
          }
      }

      // post and count map.
      site.posts.forEach(function (post) {
          var month = post.date.format('YYYY-MM');
          if (monthMap.has(month)) {
              monthMap.set(month, monthMap.get(month) + 1);
          }
      });

      // xAxis data and yAxis data.
      var monthArr = JSON.stringify([...monthMap.keys()]);
      var monthValueArr = JSON.stringify([...monthMap.values()]);
      %>

      let option1 = {
          title: {
              text: '<%- __("postPublishChart")  %>',
              top: -5,
              x: 'center'
          },
          tooltip: {
              trigger: 'axis'
          },
          xAxis: {
              type: 'category',
              data: <%- monthArr %>
          },
          yAxis: {
              type: 'value',
          },
          series: [
              {
                  name: '<%- __("postsNumberName")  %>',
                  type: 'line',
                  color: ['#6772e5'],
                  data: <%- monthValueArr %>,
                  markPoint: {
                      symbolSize: 45,
                      color: ['#fa755a','#3ecf8e','#82d3f4'],
                      data: [{
                          type: 'max',
                          itemStyle: {color: ['#3ecf8e']},
                          name: '<%- __("maximum")  %>'
                      }, {
                          type: 'min',
                          itemStyle: {color: ['#fa755a']},
                          name: '<%- __("minimum")  %>'
                      }]
                  },
                  markLine: {
                      itemStyle: {color: ['#ab47bc']},
                      data: [
                          {type: 'average', name: '<%- __("average")  %>'}
                      ]
                  }
              }
          ]
      };


      <%
      /* calculate categoriesOption data. */
      var categoryArr = [];
      site.categories.map(function(category) {
          categoryArr.push({'name': category.name, 'value': category.length})
      });

      var categoryArrJson = JSON.stringify(categoryArr);
      %>

      let option2 = {
          title: {
              text: '<%- __("categoriesChart")  %>',
              top: -4,
              x: 'center'
          },
          tooltip: {
              trigger: 'item',
              formatter: "{a} <br/>{b} : {c} ({d}%)"
          },
          series: [
              {
                  name: '<%- __("categories")  %>',
                  type: 'pie',
                  radius: '50%',
                  color: ['#6772e5', '#ff9e0f', '#fa755a', '#3ecf8e', '#82d3f4', '#ab47bc', '#525f7f', '#f51c47', '#26A69A'],
                  data: <%- categoryArrJson %>,
                  itemStyle: {
                      emphasis: {
                          shadowBlur: 10,
                          shadowOffsetX: 0,
                          shadowColor: 'rgba(0, 0, 0, 0.5)'
                      }
                  }
              }
          ]
      };
      <%
    /* calculate tagsOption data. */
    // get all tags name and count,then order by length desc.
    var tagArr = [];
    site.tags.map(function(tag) {
        tagArr.push({'name': tag.name, 'value': tag.length});
    });
    tagArr.sort((a, b) => {return b.value - a.value});

    // get Top 10 tags name and count.
    var tagNameArr = [];
    var tagCountArr = [];
    for (var i = 0, len = Math.min(tagArr.length, 10); i < len; i++) {
        tagNameArr.push(tagArr[i].name);
        tagCountArr.push(tagArr[i].value);
    }

    var tagNameArrJson = JSON.stringify(tagNameArr);
    var tagCountArrJson = JSON.stringify(tagCountArr);
    %>

    let option3 = {
        title: {
            text: '<%- __("top10TagsChart")  %>',
            top: -5,
            x: 'center'
        },
        tooltip: {},
        xAxis: [
            {
                type: 'category',
                data: <%- tagNameArrJson %>
            }
        ],
        yAxis: [
            {
                type: 'value'
            }
        ],
        series: [
            {
                type: 'bar',
                color: ['#82d3f4'],
                barWidth : 18,
                data: <%- tagCountArrJson %>,
                markPoint: {
                    symbolSize: 45,
                    data: [{
                        type: 'max',
                        itemStyle: {color: ['#3ecf8e']},
                        name: '<%- __("maximum")  %>'
                    }, {
                        type: 'min',
                        itemStyle: {color: ['#fa755a']},
                        name: '<%- __("minimum")  %>'
                    }],
                },
                markLine: {
                    itemStyle: {color: ['#ab47bc']},
                    data: [
                        {type: 'average', name: '<%- __("average")  %>'}
                    ]
                }
            }
        ]
    };

    myChart1.setOption(option1);
    myChart2.setOption(option2);
    myChart3.setOption(option3);
    window.Î¿nresize = function () {
      myChart1.resize();
      myChart2.resize();
      myChart3.resize();
    };
</script>
